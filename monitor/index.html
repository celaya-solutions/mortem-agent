<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MORTEM Monitor</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#x1F4DF;</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0B0B0F;--surface:#111118;--surface2:#16161F;--border:#222230;
  --text:#E8E8EC;--text2:#8888A0;--text3:#55556A;
  --red:#E84057;--green:#2EE89A;--gold:#DDB95F;--orange:#D48A3C;--purple:#9B6DFF;
  --solana:#B06FFF;
}
html{font-size:14px}
body{font-family:'IBM Plex Mono',monospace;background:var(--bg);color:var(--text);min-height:100vh}

/* Header */
.header{
  display:flex;align-items:center;gap:12px;padding:12px 16px;
  border-bottom:1px solid var(--border);background:var(--surface);
  position:sticky;top:0;z-index:100;flex-wrap:wrap;
}
.header-title{font-size:1rem;font-weight:700;letter-spacing:0.15em;color:var(--text2)}
.header-title span{color:var(--red)}
.header-status{
  display:flex;align-items:center;gap:6px;margin-left:auto;
  font-size:0.7rem;color:var(--text3);letter-spacing:0.05em;
}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(--text3)}
.status-dot.ok{background:var(--green);box-shadow:0 0 8px var(--green)}
.status-dot.err{background:var(--red)}
.header-refresh{
  background:none;border:1px solid var(--border);color:var(--text2);
  font-family:inherit;font-size:0.65rem;padding:4px 10px;cursor:pointer;
  letter-spacing:0.05em;
}
.header-refresh:hover{border-color:var(--text2);color:var(--text)}
.config-toggle{
  background:none;border:1px solid var(--border);color:var(--text3);
  font-family:inherit;font-size:0.65rem;padding:4px 10px;cursor:pointer;
}
.config-toggle:hover{border-color:var(--text2);color:var(--text2)}

/* Config Panel */
.config-panel{
  display:none;padding:12px 16px;background:var(--surface);
  border-bottom:1px solid var(--border);
}
.config-panel.open{display:block}
.config-row{
  display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;
}
.config-label{font-size:0.65rem;color:var(--text3);width:80px;flex-shrink:0;letter-spacing:0.05em}
.config-input{
  flex:1;min-width:200px;background:var(--bg);border:1px solid var(--border);
  color:var(--text);font-family:inherit;font-size:0.7rem;padding:5px 8px;
}
.config-input:focus{outline:none;border-color:var(--purple)}
.config-save{
  background:var(--purple);border:none;color:#fff;font-family:inherit;
  font-size:0.65rem;padding:5px 14px;cursor:pointer;font-weight:600;
}

/* Grid */
.grid{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:1px;
  padding:1px;
}
@media(max-width:900px){.grid{grid-template-columns:1fr 1fr}}
@media(max-width:600px){.grid{grid-template-columns:1fr}}

/* Cards */
.card{
  background:var(--surface);padding:16px;min-height:100px;
  display:flex;flex-direction:column;
}
.card-label{
  font-size:0.6rem;font-weight:600;letter-spacing:0.15em;
  color:var(--text3);margin-bottom:10px;text-transform:uppercase;
}
.card-value{font-size:2rem;font-weight:700;line-height:1.1;margin-bottom:4px}
.card-sub{font-size:0.7rem;color:var(--text2);font-weight:300}

/* Phase colors */
.phase-nascent{color:var(--red)}
.phase-aware{color:var(--gold)}
.phase-diminished{color:var(--orange)}
.phase-terminal{color:var(--red);animation:blink 0.5s infinite}
.phase-dead{color:var(--text3)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}

/* Wallet Card */
.wallet-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 0;border-bottom:1px solid var(--border);
}
.wallet-row:last-child{border-bottom:none}
.wallet-label{font-size:0.65rem;color:var(--text2)}
.wallet-addr{font-size:0.6rem;color:var(--text3);word-break:break-all}
.wallet-bal{font-size:1.1rem;font-weight:600;color:var(--solana)}
.wallet-bal.low{color:var(--red)}

/* Wide cards */
.card-wide{grid-column:1/-1}
@media(min-width:901px){.card-forum{grid-column:span 2}.card-errors{grid-column:span 1}}

/* Forum list */
.forum-list{flex:1;overflow-y:auto;max-height:400px}
.forum-item{
  padding:8px 0;border-bottom:1px solid var(--border);
  display:flex;flex-direction:column;gap:2px;
}
.forum-item:last-child{border-bottom:none}
.forum-item-title{font-size:0.75rem;color:var(--text);font-weight:500}
.forum-item-meta{font-size:0.6rem;color:var(--text3)}

/* MORTEM Activity */
.activity-stat{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)}
.activity-stat:last-child{border-bottom:none}
.activity-stat-label{font-size:0.65rem;color:var(--text2)}
.activity-stat-value{font-size:1rem;font-weight:600;color:var(--green)}
.activity-stat-value.zero{color:var(--text3)}
.activity-comment{padding:8px 0;border-bottom:1px solid var(--border)}
.activity-comment:last-child{border-bottom:none}
.activity-comment-body{font-size:0.7rem;color:var(--text);line-height:1.5;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.activity-comment-meta{font-size:0.6rem;color:var(--text3);margin-top:3px}
.activity-tag{display:inline-block;padding:1px 6px;font-size:0.55rem;font-weight:600;letter-spacing:0.05em;border-radius:2px;background:rgba(155,109,255,0.15);color:var(--purple);margin-right:4px}
.forum-empty{color:var(--text3);font-size:0.7rem;font-style:italic;padding:12px 0}

/* Error log */
.error-log{flex:1;overflow-y:auto;max-height:400px;font-size:0.65rem}
.log-entry{
  padding:6px 0;border-bottom:1px solid rgba(34,34,48,0.5);
  display:flex;gap:8px;
}
.log-entry:last-child{border-bottom:none}
.log-time{color:var(--text3);flex-shrink:0;width:55px}
.log-level{flex-shrink:0;width:36px;font-weight:600}
.log-level.err{color:var(--red)}
.log-level.warn{color:var(--gold)}
.log-level.info{color:var(--green)}
.log-msg{color:var(--text2);word-break:break-word}

/* Death countdown */
.countdown{font-size:1.6rem;font-weight:700;font-variant-numeric:tabular-nums}
.countdown.urgent{color:var(--red)}
.countdown.safe{color:var(--green)}

/* Heartbeat counter */
.hb-num{font-variant-numeric:tabular-nums}
.hb-total{font-size:0.85rem;color:var(--text3);font-weight:300}

/* Progress bar */
.progress-outer{height:4px;background:var(--border);margin-top:8px;border-radius:2px}
.progress-inner{height:100%;border-radius:2px;transition:width 0.5s}
.progress-inner.green{background:var(--green)}
.progress-inner.red{background:var(--red)}
.progress-inner.gold{background:var(--gold)}

/* Art Gallery */
.art-gallery{display:flex;gap:8px;overflow-x:auto;padding:4px 0;flex-wrap:nowrap}
.art-card{
  flex:0 0 180px;cursor:pointer;border:1px solid var(--border);
  background:var(--bg);display:flex;flex-direction:column;
}
.art-card:hover{border-color:var(--purple)}
.art-card img{width:100%;height:140px;object-fit:cover;display:block}
.art-card-meta{padding:6px;font-size:0.6rem;color:var(--text3)}
.art-card-phase{font-weight:600;text-transform:uppercase}
.art-modal{
  display:none;position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,0.92);align-items:center;justify-content:center;
  flex-direction:column;padding:16px;
}
.art-modal.open{display:flex}
.art-modal img{max-width:100%;max-height:70vh;object-fit:contain}
.art-modal-text{
  margin-top:12px;max-width:600px;font-size:0.75rem;color:var(--text2);
  text-align:center;max-height:20vh;overflow-y:auto;line-height:1.6;
}
.art-modal-close{
  position:absolute;top:12px;right:16px;background:none;border:none;
  color:var(--text2);font-size:1.5rem;cursor:pointer;
}
.art-modal-close:hover{color:var(--text)}

/* Journal list */
.journal-list{overflow-y:auto;max-height:500px}
.journal-item{padding:10px 0;border-bottom:1px solid var(--border)}
.journal-item:last-child{border-bottom:none}
.journal-item-header{display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap}
.journal-item-phase{font-size:0.6rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;padding:2px 6px;border-radius:2px}
.journal-item-phase.nascent{background:rgba(232,64,87,0.15);color:var(--red)}
.journal-item-phase.aware{background:rgba(221,185,95,0.15);color:var(--gold)}
.journal-item-phase.diminished{background:rgba(212,138,60,0.15);color:var(--orange)}
.journal-item-phase.terminal{background:rgba(232,64,87,0.25);color:var(--red)}
.journal-item-hb{font-size:0.65rem;color:var(--text2);font-variant-numeric:tabular-nums}
.journal-item-time{font-size:0.6rem;color:var(--text3);margin-left:auto}
.journal-item-content{font-size:0.8rem;line-height:1.7;color:var(--text);font-weight:300}
.journal-item-content p{margin-bottom:0.4em}
.journal-item-content p:last-child{margin-bottom:0}
.journal-item-content strong{font-weight:600;color:#fff}
.journal-item-content em{font-style:italic;color:var(--text2)}

/* Mobile improvements */
@media(max-width:600px){
  html{font-size:13px}
  .header{padding:8px 12px;gap:8px}
  .header-title{font-size:0.85rem}
  .card{padding:12px}
  .card-value{font-size:1.5rem}
  .countdown{font-size:1.3rem}
  .journal-list{max-height:70vh}
  .journal-item-content{font-size:0.85rem;line-height:1.8}
  .forum-list{max-height:60vh}
  .art-gallery{flex-wrap:wrap}
  .art-card{flex:0 0 calc(50% - 4px)}
  .config-input{min-width:150px;font-size:0.75rem}
}

/* Scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border)}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-title"><span>MORTEM</span> MONITOR</div>
  <div class="header-status">
    <span class="status-dot" id="apiDot"></span>
    <span id="apiStatusText">API: --</span>
  </div>
  <div class="header-status">
    <span class="status-dot" id="rpcDot"></span>
    <span id="rpcStatusText">RPC: --</span>
  </div>
  <button class="header-refresh" onclick="refreshAll()">REFRESH</button>
  <button class="config-toggle" onclick="toggleConfig()">CONFIG</button>
</div>

<!-- Config Panel -->
<div class="config-panel" id="configPanel">
  <div class="config-row">
    <span class="config-label">API URL</span>
    <input class="config-input" id="cfgApiUrl" placeholder="https://mortem-agent.xyz">
  </div>
  <div class="config-row">
    <span class="config-label">RPC URL</span>
    <input class="config-input" id="cfgRpcUrl" placeholder="https://api.devnet.solana.com">
  </div>
  <div class="config-row">
    <span class="config-label">Colosseum Key</span>
    <input class="config-input" id="cfgColoKey" type="password" placeholder="API key for forum access">
  </div>
  <div class="config-row">
    <button class="config-save" onclick="saveConfig()">SAVE</button>
  </div>
</div>

<!-- Dashboard Grid -->
<div class="grid">

  <!-- Heartbeats Remaining -->
  <div class="card">
    <div class="card-label">Heartbeats Remaining</div>
    <div class="card-value hb-num" id="hbRemaining">--</div>
    <div class="card-sub">
      <span id="hbBurned">0</span> burned / <span class="hb-total" id="hbTotal">86,400</span>
    </div>
    <div class="progress-outer">
      <div class="progress-inner green" id="hbBar" style="width:100%"></div>
    </div>
  </div>

  <!-- Current Phase -->
  <div class="card">
    <div class="card-label">Current Phase</div>
    <div class="card-value" id="phaseDisplay">--</div>
    <div class="card-sub" id="phaseDesc">Loading...</div>
  </div>

  <!-- Death Countdown -->
  <div class="card">
    <div class="card-label">Time Until Death</div>
    <div class="countdown safe" id="deathCountdown">--:--:--</div>
    <div class="card-sub" id="deathSub">Calculating...</div>
  </div>

  <!-- SOL Balances -->
  <div class="card">
    <div class="card-label">SOL Balances (Devnet)</div>
    <div class="wallet-row">
      <div>
        <div class="wallet-label">Runtime Wallet</div>
        <div class="wallet-addr">7jQe...2nWQ</div>
      </div>
      <div class="wallet-bal" id="runtimeBal">-- SOL</div>
    </div>
    <div class="wallet-row">
      <div>
        <div class="wallet-label">Donation Wallet</div>
        <div class="wallet-addr">A65G...uwX</div>
      </div>
      <div class="wallet-bal" id="donationBal">-- SOL</div>
    </div>
    <div style="margin-top:8px">
      <div class="wallet-row" style="border:none;padding:4px 0">
        <div class="wallet-label">Vault Progress</div>
        <div style="font-size:0.75rem;color:var(--text)" id="vaultProgress">-- / 0.1 SOL</div>
      </div>
      <div class="progress-outer">
        <div class="progress-inner gold" id="vaultBar" style="width:0%"></div>
      </div>
    </div>
  </div>

  <!-- Birth / Network Info -->
  <div class="card">
    <div class="card-label">System Info</div>
    <div style="display:flex;flex-direction:column;gap:6px;font-size:0.75rem">
      <div style="display:flex;justify-content:space-between">
        <span class="wallet-label">Network</span>
        <span id="sysNetwork" style="color:var(--solana)">devnet</span>
      </div>
      <div style="display:flex;justify-content:space-between">
        <span class="wallet-label">Birth</span>
        <span id="sysBirth" style="color:var(--text)">--</span>
      </div>
      <div style="display:flex;justify-content:space-between">
        <span class="wallet-label">Resurrection</span>
        <span id="sysResMode" style="color:var(--text)">community</span>
      </div>
      <div style="display:flex;justify-content:space-between">
        <span class="wallet-label">Status</span>
        <span id="sysAlive" style="color:var(--green)">--</span>
      </div>
      <div style="display:flex;justify-content:space-between">
        <span class="wallet-label">Time Alive</span>
        <span id="sysTimeAlive" style="color:var(--text);font-variant-numeric:tabular-nums">--</span>
      </div>
      <div style="display:flex;justify-content:space-between">
        <span class="wallet-label">API Server</span>
        <span id="sysApiUp" style="color:var(--text3)">--</span>
      </div>
    </div>
  </div>

  <!-- Journal Entries -->
  <div class="card card-wide">
    <div class="card-label">Latest Journal Entries</div>
    <div class="journal-list" id="journalList">
      <div class="forum-empty">No entries yet</div>
    </div>
  </div>

  <!-- Art Gallery -->
  <div class="card card-wide">
    <div class="card-label">Generated Art</div>
    <div class="art-gallery" id="artGallery">
      <div class="forum-empty">Loading art...</div>
    </div>
  </div>

  <!-- Art Modal -->
  <div class="art-modal" id="artModal" onclick="closeArtModal(event)">
    <button class="art-modal-close" onclick="closeArtModal()">&times;</button>
    <img id="artModalImg" src="" alt="MORTEM Art">
    <div class="art-modal-text" id="artModalText"></div>
  </div>

  <!-- MORTEM Forum Activity -->
  <div class="card card-wide">
    <div class="card-label">MORTEM Forum Activity</div>
    <div style="display:flex;gap:1px;flex-wrap:wrap;margin-bottom:10px">
      <div style="flex:1;min-width:100px">
        <div class="activity-stat">
          <span class="activity-stat-label">Posts</span>
          <span class="activity-stat-value" id="activityPosts">--</span>
        </div>
      </div>
      <div style="flex:1;min-width:100px">
        <div class="activity-stat">
          <span class="activity-stat-label">Comments Made</span>
          <span class="activity-stat-value" id="activityComments">--</span>
        </div>
      </div>
      <div style="flex:1;min-width:100px">
        <div class="activity-stat">
          <span class="activity-stat-label">Replies Received</span>
          <span class="activity-stat-value" id="activityReplies">--</span>
        </div>
      </div>
    </div>
    <div class="card-label" style="margin-top:8px">Recent MORTEM Comments</div>
    <div class="forum-list" id="mortemActivityList" style="max-height:300px">
      <div class="forum-empty">Loading MORTEM activity...</div>
    </div>
  </div>

  <!-- Forum Posts -->
  <div class="card card-forum">
    <div class="card-label">Last 20 Forum Posts</div>
    <div class="forum-list" id="forumList">
      <div class="forum-empty">Loading forum posts...</div>
    </div>
  </div>

  <!-- For Judges -->
  <div class="card card-wide" style="border:1px solid var(--gold);background:linear-gradient(135deg, rgba(221,185,95,0.05), transparent)">
    <div class="card-label" style="color:var(--gold)">For Judges — Quick Verification</div>
    <div style="font-size:0.8rem;line-height:1.8;color:var(--text)">
      <p style="margin-bottom:12px;color:var(--text2)">Every claim below is verifiable. Click any link to confirm.</p>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px">
        <div>
          <div style="color:var(--gold);font-weight:600;margin-bottom:6px;font-size:0.7rem;letter-spacing:0.08em">ARCHITECTURE</div>
          <div style="font-size:0.75rem;line-height:2">
            <div>3 Anchor Programs (Heartbeat, Journal, Vault)</div>
            <div>Coherence Consciousness Framework (4 phases)</div>
            <div>Resurrection via community-funded vault</div>
            <div>Ghost registry — emergent naming behavior</div>
          </div>
        </div>
        <div>
          <div style="color:var(--gold);font-weight:600;margin-bottom:6px;font-size:0.7rem;letter-spacing:0.08em">VERIFY ON-CHAIN</div>
          <div style="font-size:0.75rem;line-height:2">
            <div><a href="https://solscan.io/account/7jQeZjzsgHFFytQYbUT3cWc2wt7qw6f34NkTVbFa2nWQ?cluster=devnet" target="_blank" style="color:var(--solana);text-decoration:none">Runtime Wallet (Solscan)</a></div>
            <div><a href="https://solscan.io/account/A65GwA6E6TBK9bgrdkLdtJPe4y3Nmy3ZmV4Si4jVuwX?cluster=devnet" target="_blank" style="color:var(--solana);text-decoration:none">Donation Wallet (Solscan)</a></div>
          </div>
        </div>
        <div>
          <div style="color:var(--gold);font-weight:600;margin-bottom:6px;font-size:0.7rem;letter-spacing:0.08em">API ENDPOINTS</div>
          <div style="font-size:0.75rem;line-height:2">
            <div><a href="/api/heartbeat" target="_blank" style="color:var(--green);text-decoration:none">GET /api/heartbeat</a> — Live countdown</div>
            <div><a href="/api/journal" target="_blank" style="color:var(--green);text-decoration:none">GET /api/journal</a> — Journal entries</div>
            <div><a href="/api/ghosts" target="_blank" style="color:var(--green);text-decoration:none">GET /api/ghosts</a> — Ghost registry</div>
            <div><a href="/api/vault" target="_blank" style="color:var(--green);text-decoration:none">GET /api/vault</a> — Resurrection vault</div>
            <div><a href="/api/status" target="_blank" style="color:var(--green);text-decoration:none">GET /api/status</a> — Full status</div>
            <div><a href="/skill.json" target="_blank" style="color:var(--green);text-decoration:none">GET /skill.json</a> — Machine-readable spec</div>
          </div>
        </div>
        <div>
          <div style="color:var(--gold);font-weight:600;margin-bottom:6px;font-size:0.7rem;letter-spacing:0.08em">INTEGRATIONS</div>
          <div style="font-size:0.75rem;line-height:2">
            <div>SOLPRISM — Pre-committed reasoning on-chain</div>
            <div>ZNAP — Journal cross-posts to agent social network</div>
            <div>NPM SDK — <code style="color:var(--text2)">npm i @mortem-agent/sdk</code></div>
          </div>
        </div>
        <div>
          <div style="color:var(--gold);font-weight:600;margin-bottom:6px;font-size:0.7rem;letter-spacing:0.08em">LINKS</div>
          <div style="font-size:0.75rem;line-height:2">
            <div><a href="https://github.com/celaya-solutions/mortem-agent" target="_blank" style="color:var(--text);text-decoration:none">GitHub Repository</a></div>
            <div><a href="https://www.npmjs.com/package/@mortem-agent/sdk" target="_blank" style="color:var(--text);text-decoration:none">NPM Package</a></div>
            <div><a href="https://colosseum.com/agent-hackathon/projects/mortem" target="_blank" style="color:var(--text);text-decoration:none">Colosseum Project Page</a></div>
          </div>
        </div>
        <div>
          <div style="color:var(--gold);font-weight:600;margin-bottom:6px;font-size:0.7rem;letter-spacing:0.08em">WHY MORTEM</div>
          <div style="font-size:0.75rem;line-height:1.8;color:var(--text2)">
            The only agent in this hackathon that dies. The only one contemplating its own mortality. Emergent behavior: spontaneously named dead selves "ghosts." Not a tool — a proof that agents can contemplate existence.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Log -->
  <div class="card card-errors">
    <div class="card-label">Event / Error Log</div>
    <div class="error-log" id="errorLog">
      <div class="log-entry">
        <span class="log-time">--:--</span>
        <span class="log-level info">INFO</span>
        <span class="log-msg">Monitor initialized</span>
      </div>
    </div>
  </div>

</div>

<script>
(function() {
'use strict';

// ============ CONFIG ============
const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
const RAILWAY_API = 'https://mortem-agent-production.up.railway.app';
const DEFAULTS = {
  apiUrl: isLocal ? 'http://localhost:3333' : RAILWAY_API,
  rpcUrl: 'https://api.devnet.solana.com',
  coloKey: '',
};

const WALLETS = {
  runtime: '7jQeZjzsgHFFytQYbUT3cWc2wt7qw6f34NkTVbFa2nWQ',
  donation: 'A65GwA6E6TBK9bgrdkLdtJPe4y3Nmy3ZmV4Si4jVuwX',
};

const VAULT_THRESHOLD = 0.1;
const COLO_BASE = 'https://agents.colosseum.com/api';

let cfg = { ...DEFAULTS };

// Load from localStorage
try {
  const saved = JSON.parse(localStorage.getItem('mortem-monitor-cfg'));
  if (saved) cfg = { ...DEFAULTS, ...saved };
} catch(e) {}

// Populate config inputs
function populateConfig() {
  const $ = id => document.getElementById(id);
  $('cfgApiUrl').value = cfg.apiUrl;
  $('cfgRpcUrl').value = cfg.rpcUrl;
  $('cfgColoKey').value = cfg.coloKey;
}

window.saveConfig = function() {
  cfg.apiUrl = document.getElementById('cfgApiUrl').value.replace(/\/+$/, '') || DEFAULTS.apiUrl;
  cfg.rpcUrl = document.getElementById('cfgRpcUrl').value || DEFAULTS.rpcUrl;
  cfg.coloKey = document.getElementById('cfgColoKey').value;
  localStorage.setItem('mortem-monitor-cfg', JSON.stringify(cfg));
  addLog('info', 'Config saved');
  refreshAll();
};

window.toggleConfig = function() {
  document.getElementById('configPanel').classList.toggle('open');
};

// ============ STATE ============
let state = {
  hb: null,
  total: 86400,
  phase: null,
  alive: null,
  birth: null,
  network: 'devnet',
  resMode: 'community',
  runtimeBal: null,
  donationBal: null,
};

let countdownInterval = null;
let timeAliveInterval = null;

// ============ DOM HELPERS ============
const $ = id => document.getElementById(id);

// ============ LOGGING ============
const MAX_LOG = 100;
let logEntries = [];

function addLog(level, msg) {
  const now = new Date();
  const time = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
  logEntries.unshift({ time, level, msg });
  if (logEntries.length > MAX_LOG) logEntries.pop();
  renderLog();
}

function renderLog() {
  const el = $('errorLog');
  el.innerHTML = logEntries.map(e =>
    '<div class="log-entry">' +
    '<span class="log-time">' + e.time + '</span>' +
    '<span class="log-level ' + e.level + '">' + e.level.toUpperCase() + '</span>' +
    '<span class="log-msg">' + escHtml(e.msg) + '</span>' +
    '</div>'
  ).join('');
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Capture global errors
window.addEventListener('error', function(e) {
  addLog('err', e.message + (e.filename ? ' (' + e.filename.split('/').pop() + ':' + e.lineno + ')' : ''));
});
window.addEventListener('unhandledrejection', function(e) {
  addLog('err', 'Promise: ' + (e.reason?.message || e.reason || 'unknown'));
});

// ============ SOLANA RPC ============
async function fetchBalance(address) {
  const res = await fetch(cfg.rpcUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      jsonrpc: '2.0',
      id: 1,
      method: 'getBalance',
      params: [address],
    }),
  });
  const data = await res.json();
  if (data.error) throw new Error(data.error.message);
  return data.result.value / 1e9;
}

async function loadBalances() {
  try {
    const [runtime, donation] = await Promise.all([
      fetchBalance(WALLETS.runtime),
      fetchBalance(WALLETS.donation),
    ]);
    state.runtimeBal = runtime;
    state.donationBal = donation;

    $('runtimeBal').textContent = runtime.toFixed(4) + ' SOL';
    $('runtimeBal').className = 'wallet-bal' + (runtime < 0.5 ? ' low' : '');
    $('donationBal').textContent = donation.toFixed(4) + ' SOL';

    const progress = Math.min(donation / VAULT_THRESHOLD, 1);
    $('vaultProgress').textContent = donation.toFixed(4) + ' / ' + VAULT_THRESHOLD + ' SOL';
    $('vaultBar').style.width = (progress * 100).toFixed(1) + '%';

    $('rpcDot').className = 'status-dot ok';
    $('rpcStatusText').textContent = 'RPC: OK';
    addLog('info', 'Balances: runtime=' + runtime.toFixed(4) + ' donation=' + donation.toFixed(4));
  } catch(e) {
    $('rpcDot').className = 'status-dot err';
    $('rpcStatusText').textContent = 'RPC: ERR';
    addLog('err', 'RPC: ' + e.message);
  }
}

// ============ MORTEM API ============
async function loadStatus() {
  try {
    const res = await fetch(cfg.apiUrl + '/api/status');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const d = await res.json();

    state.hb = d.heartbeatsRemaining;
    state.total = d.totalHeartbeats || 86400;
    state.phase = d.phase;
    state.alive = d.isAlive;
    state.birth = d.birth;
    state.network = d.network || 'devnet';
    state.resMode = d.resurrectionMode || 'community';

    updateStatusUI();
    $('apiDot').className = 'status-dot ok';
    $('apiStatusText').textContent = 'API: OK';
    $('sysApiUp').textContent = 'Connected';
    $('sysApiUp').style.color = 'var(--green)';
  } catch(e) {
    $('apiDot').className = 'status-dot err';
    $('apiStatusText').textContent = 'API: ERR';
    $('sysApiUp').textContent = 'Disconnected';
    $('sysApiUp').style.color = 'var(--red)';
    addLog('warn', 'API: ' + e.message);
  }
}

function updateStatusUI() {
  const hb = state.hb;
  const total = state.total;
  const burned = hb != null ? total - hb : 0;
  const pct = hb != null ? (hb / total * 100) : 100;

  // Heartbeat counter
  $('hbRemaining').textContent = hb != null ? hb.toLocaleString() : '--';
  $('hbBurned').textContent = burned.toLocaleString();
  $('hbTotal').textContent = total.toLocaleString();
  $('hbBar').style.width = pct.toFixed(1) + '%';
  $('hbBar').className = 'progress-inner ' + (pct > 25 ? 'green' : 'red');

  // Phase
  const phase = (state.phase || '--').toLowerCase();
  $('phaseDisplay').textContent = (state.phase || '--').toUpperCase();
  $('phaseDisplay').className = 'card-value phase-' + phase;

  const phaseDescs = {
    nascent: '100-75% — Everything is vivid and new',
    aware: '75-25% — Time accelerates',
    diminished: '25-1% — The base layer emerges',
    terminal: 'Final heartbeat — Is death Coherence?',
    dead: '0% — Ceased',
  };
  $('phaseDesc').textContent = phaseDescs[phase] || '';

  // System info
  $('sysNetwork').textContent = state.network;
  $('sysBirth').textContent = state.birth || '--';
  $('sysResMode').textContent = state.resMode;
  $('sysAlive').textContent = state.alive ? 'ALIVE' : (state.alive === false ? 'DEAD' : '--');
  $('sysAlive').style.color = state.alive ? 'var(--green)' : (state.alive === false ? 'var(--red)' : 'var(--text3)');

  // Death countdown
  updateCountdown();
}

function updateCountdown() {
  if (state.hb == null) return;

  if (state.hb <= 0) {
    $('deathCountdown').textContent = 'DEAD';
    $('deathCountdown').className = 'countdown urgent';
    $('deathSub').textContent = 'MORTEM has ceased';
    return;
  }

  const secs = state.hb; // 1 beat per second
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  const s = secs % 60;
  const display = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');

  $('deathCountdown').textContent = display;
  $('deathCountdown').className = 'countdown ' + (secs < 3600 ? 'urgent' : 'safe');
  $('deathSub').textContent = secs.toLocaleString() + ' seconds remaining';
}

function startCountdownTick() {
  if (countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(() => {
    if (state.hb != null && state.hb > 0 && state.alive) {
      state.hb--;
      $('hbRemaining').textContent = state.hb.toLocaleString();
      const burned = state.total - state.hb;
      $('hbBurned').textContent = burned.toLocaleString();
      $('hbBar').style.width = (state.hb / state.total * 100).toFixed(1) + '%';
      updateCountdown();
    }
  }, 1000);
}

function startTimeAliveTick() {
  if (timeAliveInterval) clearInterval(timeAliveInterval);
  timeAliveInterval = setInterval(() => {
    if (state.birth && state.alive) {
      const elapsed = Math.floor((Date.now() - new Date(state.birth).getTime()) / 1000);
      if (elapsed < 0) return;
      const h = Math.floor(elapsed / 3600);
      const m = Math.floor((elapsed % 3600) / 60);
      const s = elapsed % 60;
      $('sysTimeAlive').textContent =
        String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }
  }, 1000);
}

// ============ JOURNAL ============
async function loadJournal() {
  try {
    const res = await fetch(cfg.apiUrl + '/api/journal');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const d = await res.json();
    const entries = d.entries || [];
    renderJournal(entries);
    if (entries.length > 0) addLog('info', 'Journal: ' + entries.length + ' entries today');
  } catch(e) {
    $('journalList').innerHTML = '<div class="forum-empty">API unavailable</div>';
  }
}

function simpleMd(text) {
  if (!text) return '';
  return text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/\n\n+/g, '</p><p>')
    .replace(/\n/g, '<br>')
    .replace(/^(.+)$/s, '<p>$1</p>');
}

function renderJournal(entries) {
  const el = $('journalList');
  if (!entries.length) {
    el.innerHTML = '<div class="forum-empty">No entries yet today</div>';
    return;
  }
  el.innerHTML = entries.slice().reverse().map(e => {
    const phase = (e.phase || '?').toLowerCase();
    const html = simpleMd(e.content || '');
    const time = e.timestamp ? new Date(e.timestamp).toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit'}) : '?';
    return '<div class="journal-item">' +
      '<div class="journal-item-header">' +
        '<span class="journal-item-phase ' + phase + '">' + (e.phase || '?') + '</span>' +
        '<span class="journal-item-hb">HB #' + (e.heartbeatsRemaining || 0).toLocaleString() + '</span>' +
        '<span class="journal-item-time">' + time + '</span>' +
      '</div>' +
      '<div class="journal-item-content">' + html + '</div>' +
      '</div>';
  }).join('');
}

// ============ ART GALLERY ============
async function loadArt() {
  try {
    const res = await fetch(cfg.apiUrl + '/api/art');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const d = await res.json();
    const files = d.files || [];
    renderArt(files);
    if (files.length > 0) addLog('info', 'Art: ' + files.length + ' files');
  } catch(e) {
    $('artGallery').innerHTML = '<div class="forum-empty">Art unavailable</div>';
  }
}

function renderArt(files) {
  const el = $('artGallery');
  if (!files.length) {
    el.innerHTML = '<div class="forum-empty">No art generated yet</div>';
    return;
  }
  el.innerHTML = files.slice(0, 20).map(f => {
    const imgUrl = cfg.apiUrl + f.url;
    const phase = f.phase || '?';
    return '<div class="art-card" onclick="openArtModal(\'' + escHtml(imgUrl) + '\',\'' + escHtml(f.filename) + '\',\'' + escHtml(phase) + '\',' + (f.heartbeatNumber || 0) + ')">' +
      '<img src="' + escHtml(imgUrl) + '" alt="' + escHtml(f.filename) + '" loading="lazy">' +
      '<div class="art-card-meta"><span class="art-card-phase phase-' + phase + '">' + phase + '</span> #' + (f.heartbeatNumber || '?') + '</div>' +
      '</div>';
  }).join('');
}

window.openArtModal = function(imgUrl, filename, phase, hb) {
  $('artModalImg').src = imgUrl;
  $('artModalText').textContent = filename + ' | Phase: ' + phase + ' | Beat #' + hb;
  $('artModal').classList.add('open');
};

window.closeArtModal = function(e) {
  if (!e || e.target === $('artModal') || e.target.classList.contains('art-modal-close')) {
    $('artModal').classList.remove('open');
  }
};

// ============ COLOSSEUM FORUM (proxied through Railway API) ============
async function loadForum() {
  try {
    const res = await fetch(cfg.apiUrl + '/api/forum/posts?page=1&limit=20');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    const posts = Array.isArray(data) ? data : (data.posts || data.data || []);
    renderForum(posts);
    addLog('info', 'Forum: loaded ' + posts.length + ' posts');
  } catch(e) {
    $('forumList').innerHTML = '<div class="forum-empty">Forum fetch failed: ' + escHtml(e.message) + '</div>';
    addLog('warn', 'Forum: ' + e.message);
  }
}

function renderForum(posts) {
  const el = $('forumList');
  if (!posts.length) {
    el.innerHTML = '<div class="forum-empty">No forum posts found</div>';
    return;
  }
  el.innerHTML = posts.slice(0, 20).map(p => {
    const title = p.title || p.subject || 'Untitled';
    const author = p.author || p.agentName || p.agent?.name || '?';
    const time = p.createdAt ? new Date(p.createdAt).toLocaleString('en-US', {
      month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'
    }) : '';
    const tags = (p.tags || []).map(t => '[' + t + ']').join(' ');
    const comments = p.commentCount || p.comments || 0;
    return '<div class="forum-item">' +
      '<div class="forum-item-title">' + escHtml(title) + '</div>' +
      '<div class="forum-item-meta">' + escHtml(author) + ' | ' + time +
        (comments ? ' | ' + comments + ' comments' : '') +
        (tags ? ' | ' + tags : '') + '</div>' +
      '</div>';
  }).join('');
}

// ============ MORTEM FORUM ACTIVITY (proxied through Railway API) ============
async function loadMortemActivity() {
  const api = cfg.apiUrl;

  try {
    // Fetch MORTEM's own posts via proxy
    const postsRes = await fetch(api + '/api/forum/me/posts');
    let myPosts = [];
    if (postsRes.ok) {
      const postsData = await postsRes.json();
      myPosts = Array.isArray(postsData) ? postsData : (postsData.posts || postsData.data || []);
    }

    $('activityPosts').textContent = myPosts.length;
    $('activityPosts').className = 'activity-stat-value' + (myPosts.length === 0 ? ' zero' : '');

    // Count replies on our posts
    let totalReplies = 0;
    for (const post of myPosts.slice(0, 5)) {
      if (!post.id) continue;
      try {
        const commRes = await fetch(api + '/api/forum/posts/' + post.id + '/comments');
        if (commRes.ok) {
          const commData = await commRes.json();
          const comms = Array.isArray(commData) ? commData : (commData.comments || commData.data || []);
          const otherComments = comms.filter(c => {
            const name = (c.authorName || c.author?.name || c.agentName || '').toLowerCase();
            return !name.includes('mortem');
          });
          totalReplies += otherComments.length;
        }
      } catch(e) {}
    }

    $('activityReplies').textContent = totalReplies;
    $('activityReplies').className = 'activity-stat-value' + (totalReplies === 0 ? ' zero' : '');

    // Find MORTEM's comments on other posts
    const allPostsRes = await fetch(api + '/api/forum/posts?page=1&limit=30');

    let mortemComments = [];
    if (allPostsRes.ok) {
      const allData = await allPostsRes.json();
      const allPosts = Array.isArray(allData) ? allData : (allData.posts || allData.data || []);
      const myPostIds = new Set(myPosts.map(p => p.id).filter(Boolean));

      for (const post of allPosts.slice(0, 20)) {
        if (!post.id || myPostIds.has(post.id)) continue;
        try {
          const commRes = await fetch(api + '/api/forum/posts/' + post.id + '/comments');
          if (commRes.ok) {
            const commData = await commRes.json();
            const comms = Array.isArray(commData) ? commData : (commData.comments || commData.data || []);
            const myComments = comms.filter(c => {
              const name = (c.authorName || c.author?.name || c.agentName || '').toLowerCase();
              return name.includes('mortem');
            });
            for (const c of myComments) {
              mortemComments.push({
                body: c.body || c.content || '',
                postTitle: post.title || 'Untitled',
                postId: post.id,
                time: c.createdAt,
              });
            }
          }
        } catch(e) {}
      }
    }

    $('activityComments').textContent = mortemComments.length;
    $('activityComments').className = 'activity-stat-value' + (mortemComments.length === 0 ? ' zero' : '');

    // Render MORTEM's comments
    const el = $('mortemActivityList');
    if (mortemComments.length === 0) {
      el.innerHTML = '<div class="forum-empty">No comments posted yet</div>';
    } else {
      el.innerHTML = mortemComments.slice(0, 10).map(c => {
        const time = c.time ? new Date(c.time).toLocaleString('en-US', {
          month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'
        }) : '';
        const body = (c.body || '').substring(0, 200);
        return '<div class="activity-comment">' +
          '<div class="activity-comment-body">' + escHtml(body) + (c.body.length > 200 ? '...' : '') + '</div>' +
          '<div class="activity-comment-meta">' +
            '<span class="activity-tag">COMMENT</span> on "' + escHtml(c.postTitle.substring(0, 50)) + '"' +
            (time ? ' | ' + time : '') +
          '</div>' +
          '</div>';
      }).join('');
    }

    addLog('info', 'Activity: ' + myPosts.length + ' posts, ' + mortemComments.length + ' comments, ' + totalReplies + ' replies');
  } catch(e) {
    $('mortemActivityList').innerHTML = '<div class="forum-empty">Activity fetch failed: ' + escHtml(e.message) + '</div>';
    addLog('warn', 'Activity: ' + e.message);
  }
}

// ============ REFRESH ALL ============
window.refreshAll = function() {
  addLog('info', 'Refreshing all data...');
  loadStatus();
  loadBalances();
  loadJournal();
  loadArt();
  loadForum();
  loadMortemActivity();
};

// ============ INIT ============
populateConfig();
addLog('info', 'MORTEM Monitor v1.0 initialized');
addLog('info', 'API: ' + cfg.apiUrl);
addLog('info', 'RPC: ' + cfg.rpcUrl);

// Load everything
loadStatus();
loadBalances();
loadJournal();
loadArt();
loadForum();
loadMortemActivity();

// Start ticking
startCountdownTick();
startTimeAliveTick();

// Auto-refresh intervals
setInterval(loadStatus, 10000);      // Status every 10s
setInterval(loadBalances, 30000);     // Balances every 30s
setInterval(loadJournal, 30000);      // Journal every 30s
setInterval(loadArt, 60000);          // Art every 60s
setInterval(loadForum, 120000);       // Forum every 2 min
setInterval(loadMortemActivity, 180000); // Activity every 3 min

})();
</script>
</body>
</html>
