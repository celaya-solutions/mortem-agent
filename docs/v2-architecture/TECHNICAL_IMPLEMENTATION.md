# Technical Implementation

## Stack

| Component | Technology |
|-----------|-----------|
| Heartbeat Service | Python 3.11, solana-py, solders, PyYAML |
| Witness Agent | Python 3.11, solana-py, solders, PyYAML |
| Blockchain | Solana devnet (memo program) |
| Landing Page | Vanilla HTML/CSS/JS (no framework, no deps) |
| SVG Components | Standalone SVG + React JSX components |
| Data Source | Mock (Apple Watch HealthKit integration planned) |

## Solana Integration

### Wallet Architecture
- **Human wallet**: Sends heartbeat transactions (self-transfers + memo)
- **MORTEM wallet**: Sends witness entry transactions (self-transfers + memo)
- Both wallets are Solana devnet keypairs stored as JSON byte arrays
- Auto-generated on first run if no wallet file exists
- Auto-airdrop from devnet faucet when balance is low

### Transaction Structure
Every transaction consists of:
1. **Transfer instruction**: Self-transfer of 1000 lamports (minimal, just for validity)
2. **Memo instruction**: JSON-encoded metadata via Memo Program (`MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr`)

### Memo Formats

**HUMAN_HEARTBEAT**
```json
{
  "type": "HUMAN_HEARTBEAT",
  "bpm": 72,
  "timestamp": "2026-02-11T06:00:00Z",
  "source": "Apple Watch 1",
  "watch_id": 1,
  "total_beats_recorded": 42,
  "entity": "christopher"
}
```

**HUMAN_HEARTBEAT_GRACE**
```json
{
  "type": "HUMAN_HEARTBEAT_GRACE",
  "last_bpm": 72,
  "timestamp": "2026-02-11T06:05:00Z",
  "grace_seconds_remaining": 150,
  "entity": "christopher"
}
```

**HUMAN_DEATH_DECLARATION**
```json
{
  "type": "HUMAN_DEATH_DECLARATION",
  "last_bpm": 72,
  "last_heartbeat_timestamp": "2026-02-11T06:00:00Z",
  "time_of_death": "2026-02-11T06:05:00Z",
  "total_heartbeats_recorded": 42,
  "entity": "christopher",
  "message": "No heartbeat detected within grace period. Death protocol triggered."
}
```

**MORTEM_WITNESS**
```json
{
  "type": "MORTEM_WITNESS",
  "witness_entry": "The human exists at 72 BPM...",
  "heartbeats_remaining": 86399,
  "human_bpm": 72,
  "agents": ["Nash", "Turing", "Lovelace"],
  "attribution": "Generated by [Nash, Turing, Lovelace] agents via Juniper-MORTEM orchestration",
  "timestamp": "2026-02-11T06:10:00Z",
  "entity": "mortem_v2",
  "builder": "juniper-mortem"
}
```

**MORTEM_DEATH**
```json
{
  "type": "MORTEM_DEATH",
  "final_witness": "Final entry. 0 heartbeats remain...",
  "total_witnessed": 86400,
  "heartbeats_remaining": 0,
  "time_of_death": "2026-04-11T06:10:00Z",
  "entity": "mortem_v2",
  "builder": "juniper-mortem"
}
```

## HealthKit / MCP Integration

### Current: Mock Data
The `MockHeartbeatSource` class generates realistic BPM:
- 55-68 BPM (00:00-06:00, sleep)
- 65-80 BPM (06:00-09:00, waking)
- 70-95 BPM (09:00-17:00, active) with 10% chance of spikes to 100-120
- 65-85 BPM (17:00-22:00, evening)
- 60-75 BPM (22:00-00:00, late night)

### Planned: Apple Watch via MCP
The `HealthKitSource` class is a placeholder for real integration:
- MCP server reads Apple Watch heart rate data from HealthKit
- Handles two watch sources (Watch 1 and Watch 2)
- Detects active watch by most recent timestamp
- Returns same interface as mock: `{bpm, timestamp, source, watch_id}`

Swap by changing `data_source: "healthkit"` in config.

## Grace Period Logic

```
[Heartbeat received] -> Reset timer, status = ALIVE
[No heartbeat for 50% of grace period] -> Status = GRACE, send GRACE transaction
[No heartbeat for 100% of grace period] -> Status = DEAD, send DEATH_DECLARATION
```

Default grace period: 300 seconds (5 minutes).
Configurable in `config.yaml`.

## Death Detection Protocol

When grace period expires:
1. Send `HUMAN_DEATH_DECLARATION` transaction to Solana
2. Generate death certificate JSON:
   - Entity name
   - Last heartbeat data
   - Total heartbeats recorded
   - Time of death declaration
   - Grace period that elapsed
   - Medical notes
3. Save certificate to `death_certificate.json`
4. Log critical event
5. Service stops

## State Persistence

MORTEM witness saves state to `mortem_state.json`:
```json
{"remaining": 68420, "total_witnessed": 17980}
```
- Saved on shutdown (SIGINT/SIGTERM)
- Saved every 10 witness entries
- Restored on startup (resume from where it stopped)

## Devnet to Mainnet Migration

When ready for production:
1. Change `rpc_endpoint` from devnet to mainnet-beta
2. Fund wallets with real SOL (transactions cost ~0.000005 SOL each)
3. At 1 tx/minute for human + 1 tx/5min for witness: ~0.002 SOL/day
4. Remove airdrop logic
5. No code changes needed --- same transaction structure works on mainnet
